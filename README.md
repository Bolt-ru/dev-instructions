# Универсальное соглашение о разработке (Node.js)

## Общие положения

Проект реализуется на актуальной LTS-версии Node.js.\
Используются только стабильные версии зависимостей.\
При наличии поддержки --- строгая типизация обязательна.

Код должен быть production-ready.\
Демонстрационные упрощения запрещены.\
Архитектурные компромиссы фиксируются явно.

------------------------------------------------------------------------

## Архитектура

Архитектура --- модульная, с разделением ответственности:

-   Интерфейсный слой (UI / API)\
-   Прикладной слой (use-cases)\
-   Доменная модель (инварианты, бизнес-правила)\
-   Инфраструктурный слой (I/O, интеграции, внешние зависимости)

Бизнес-логика в интерфейсном слое запрещена.\
Циклические зависимости запрещены.\
Внутренние слои не зависят от инфраструктуры.

------------------------------------------------------------------------

## Управление задачами

Все изменения выполняются только в рамках задач из трекера.\
Каждая задача имеет уникальный идентификатор очереди (Issue ID).

Требования:

-   Ветка создаётся от задачи и содержит её идентификатор.\
-   Каждый коммит содержит идентификатор задачи.\
-   Pull Request ссылается на задачу.\
-   Изменения без привязки к задаче запрещены.

------------------------------------------------------------------------

## Управление кодом и версиями

Репозиторий размещается в GitHub. Используется GitLab Flow:

-   `master` --- production\
-   `develop` --- интеграция\
-   `feature/*`\
-   `release/*`\
-   `hotfix/*`

Прямые коммиты в `master` запрещены.\
Все изменения проходят через Pull Request с обязательным review и
успешным CI.

Коммиты соответствуют Conventional Commits 1.0.0 и содержат
идентификатор задачи.

Версионирование --- строго Semantic Versioning 2.0.0.\
Версия вычисляется автоматически.\
Ручное изменение версии запрещено.\
Changelog генерируется автоматически.

Breaking changes допускаются только при увеличении major-версии.

------------------------------------------------------------------------

## CI/CD

Pipeline включает:

1.  Установку зависимостей\
2.  Линтинг\
3.  Тестирование\
4.  Проверку покрытия\
5.  Сборку\
6.  Публикацию артефактов

Сборка должна быть воспроизводимой (deterministic).\
Используется lock-файл.

При успешной и неуспешной сборке отправляется уведомление в Telegram.\
Секреты хранятся только в защищённом хранилище CI.

------------------------------------------------------------------------

## Контейнеризация

Используется multi-stage build.\
Базовый образ --- минимальный (slim или distroless).\
Контейнер запускается от непривилегированного пользователя.\
Определён healthcheck.\
Добавлен `.dockerignore`.

------------------------------------------------------------------------

## Тестирование

Разработка ведётся по TDD:

-   Сначала тест\
-   Затем минимальная реализация\
-   Затем рефакторинг

Чёткое разделение `unit / integration / e2e`.

Обязательно тестируются:

-   Доменные инварианты\
-   Граничные случаи\
-   Негативные сценарии

Тест обязателен для каждого bugfix.

------------------------------------------------------------------------

## Контракты и совместимость

Публичные интерфейсы версионируются.\
Breaking-изменения без смены major запрещены.\
Спецификации API генерируются автоматически.

------------------------------------------------------------------------

## AI-совместимость публичных данных

Все публичные данные адаптированы для машинной обработки.

Требования:

-   Строгая структура\
-   Предсказуемая схема\
-   Отсутствие скрытых полей\
-   Явная семантика полей\
-   Отсутствие зависимости от форматирования для человека\
-   Форматы пригодны для автоматической обработки (например, JSON)

Человеко-ориентированные представления отделяются от машинных.

------------------------------------------------------------------------

## Работа с данными

Изменения схем выполняются только через миграции.\
Миграции версионируются и проходят CI.\
Ручные изменения production запрещены.\
Транзакционные границы определяются явно.\
Индексы обоснованы.

------------------------------------------------------------------------

## Наблюдаемость

Логи --- структурированные.\
Обязателен correlation-id.\
Определены liveness и readiness проверки.\
Собираются метрики: latency, error rate, throughput.\
Внешние вызовы имеют явные таймауты.

Определены уровни логирования.\
Персональные и чувствительные данные в логах запрещены.

------------------------------------------------------------------------

## Безопасность

Минимизировать зависимости.\
Регулярный аудит уязвимостей.\
Принцип наименьших привилегий.\
Секреты не логируются.\
Конфигурация --- через переменные окружения.\
Следование принципам 12-Factor App.

------------------------------------------------------------------------

## Горизонтальное масштабирование

Приложение должно быть stateless.

Требования:

-   Состояние не хранится в памяти процесса\
-   Сессии не хранятся локально\
-   Все данные хранятся во внешних системах\
-   Код не предполагает единственный экземпляр

Для Node.js:

-   Не блокировать event loop\
-   CPU-bound задачи выносить в worker threads или отдельные сервисы\
-   I/O операции асинхронные

Поддержка graceful shutdown обязательна:

-   Обработка SIGTERM\
-   Завершение активных запросов\
-   Закрытие соединений

------------------------------------------------------------------------

## Кэширование

Кэширование должно быть явным и обоснованным.

Требования:

-   Определена стратегия кэширования\
-   TTL задан явно\
-   Инвалидация определена\
-   Кэш совместим с горизонтальным масштабированием

Запрещено:

-   Неограниченный in-memory кэш\
-   Отсутствие стратегии инвалидации\
-   Зависимость корректности системы от локального кэша процесса

Для распределённой среды использовать внешний кэш.

------------------------------------------------------------------------

## Производительность и сложность

Оптимизация выполняется на основании измерений.

Требования:

-   Профилирование до оптимизации\
-   Определение целевых метрик производительности\
-   Контроль latency и использования ресурсов\
-   Ограничение размера payload\
-   Явные лимиты (timeouts, memory, concurrency)

Алгоритмическая сложность должна быть осознана.

Для нетривиальных алгоритмов указывать:

-   Временную сложность\
-   Пространственную сложность

Избегать N+1 сценариев.\
Использовать кэширование и индексацию обоснованно.\
Premature optimization запрещена.

------------------------------------------------------------------------

## Качество кода

Ограничение когнитивной сложности функций.\
Глубокая вложенность запрещена.\
Мёртвый код запрещён.\
Магические числа запрещены.\
Строгая типизация обязательна при поддержке.

Используются линтер и автоформатирование.\
Pre-commit проверки обязательны.

------------------------------------------------------------------------

## Комментарии

### Self-Documenting Code

-   Осмысленные имена\
-   Малые функции\
-   Явные интерфейсы\
-   Отсутствие дублирования

Комментарии не объясняют очевидное.

### Structured Commenting

Разрешены только:

-   TODO --- с причиной\
-   FIXME --- с описанием дефекта\
-   HACK --- с обоснованием\
-   @deprecated --- с альтернативой

Любой workaround должен быть обоснован.

------------------------------------------------------------------------

## Документация

README обязателен:

-   Запуск\
-   Конфигурация\
-   Описание архитектуры

Ключевые архитектурные решения фиксируются в ADR.

------------------------------------------------------------------------

## Definition of Done

Включает:

-   Тесты\
-   Обновление документации\
-   Проверку производительности при необходимости\
-   Соответствие стандартам

Merge запрещён при нарушении CI, покрытия, линтинга или соглашения.
